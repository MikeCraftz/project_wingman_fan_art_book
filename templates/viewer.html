{% extends 'base.html' %}

{% block title %}{{ page.title }}{% endblock %}

{% block content %}
<div class="viewer-container"
    style="height: 100vh; display: flex; flex-direction: column; background: #111; padding-top: 80px;">
    <div class="viewer-controls"
        style="padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; z-index: 10; position: relative;">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <a href="{{ url_for('book') }}" class="btn" style="font-size: 0.8rem; padding: 0.5rem 1rem;">&larr; Back to
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <a href="{{ url_for('book') }}" class="btn" style="font-size: 0.8rem; padding: 0.5rem 1rem;">&larr;
                        Back to
                        Issues</a>

                    <div class="nav-controls"
                        style="display: flex; gap: 0.5rem; margin-left: 1rem; border-left: 1px solid #444; padding-left: 1rem;">
                        {% if prev_page %}
                        <a href="{{ url_for('view', name=prev_page) }}" class="btn"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem;">&larr; Prev</a>
                        {% else %}
                        <span class="btn"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem; opacity: 0.3; cursor: default;">&larr;
                            Prev</span>
                        {% endif %}

                        {% if next_page %}
                        <a href="{{ url_for('view', name=next_page) }}" class="btn"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem;">Next &rarr;</a>
                        {% else %}
                        <span class="btn"
                            style="padding: 0.5rem 1rem; font-size: 0.9rem; opacity: 0.3; cursor: default;">Next
                            &rarr;</span>
                        {% endif %}
                    </div>

                    <div class="zoom-controls"
                        style="display: flex; gap: 0.5rem; margin-left: 1rem; border-left: 1px solid #444; padding-left: 1rem;">
                        <button id="zoom-out" class="btn"
                            style="padding: 0.5rem 1rem; font-size: 1.2rem; line-height: 1;">-</button>
                        <button id="zoom-in" class="btn"
                            style="padding: 0.5rem 1rem; font-size: 1.2rem; line-height: 1;">+</button>
                        <button id="zoom-reset" class="btn"
                            style="padding: 0.5rem 1rem; font-size: 0.8rem;">Reset</button>
                    </div>
                </div>
                <h2 style="font-size: 1rem; margin: 0; color: #888;">{{ page.title }}</h2>
                <a href="{{ url_for('static', filename='img/' + page.img) }}" download class="btn"
                    style="font-size: 0.8rem; padding: 0.5rem 1rem;">Download Page</a>
        </div>

        <div class="viewer-content" id="viewer-container"
            style="flex: 1; overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; background: #000; cursor: grab;">
            <img id="viewer-image" src="{{ url_for('static', filename='img/' + page.img) }}" alt="{{ page.title }}"
                style="max-width: 90%; max-height: 90%; box-shadow: 0 0 50px rgba(0,0,0,0.5); transform-origin: center center; transition: transform 0.1s ease-out; user-select: none;">
        </div>

        <script>
            const container = document.getElementById('viewer-container');
            const img = document.getElementById('viewer-image');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            const zoomResetBtn = document.getElementById('zoom-reset');

            let scale = 1;
            let panning = false;
            let pointX = 0;
            let pointY = 0;
            let startX = 0;
            let startY = 0;

            function updateTransform() {
                img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            }

            // Zoom via buttons
            zoomInBtn.addEventListener('click', () => {
                scale += 0.2;
                updateTransform();
            });

            zoomOutBtn.addEventListener('click', () => {
                scale = Math.max(0.1, scale - 0.2);
                updateTransform();
            });

            zoomResetBtn.addEventListener('click', () => {
                scale = 1;
                pointX = 0;
                pointY = 0;
                updateTransform();
            });

            // Zoom via wheel
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                scale = Math.max(0.1, scale + delta);
                updateTransform();
            });

            // Pan via drag
            container.addEventListener('mousedown', (e) => {
                e.preventDefault();
                panning = true;
                startX = e.clientX - pointX;
                startY = e.clientY - pointY;
                container.style.cursor = 'grabbing';
                img.style.transition = 'none'; // Disable transition for direct drag
            });

            container.addEventListener('mousemove', (e) => {
                if (!panning) return;
                e.preventDefault();
                pointX = e.clientX - startX;
                pointY = e.clientY - startY;
                updateTransform();
            });

            container.addEventListener('mouseup', () => {
                panning = false;
                container.style.cursor = 'grab';
                img.style.transition = 'transform 0.1s ease-out'; // Re-enable transition
            });

            container.addEventListener('mouseleave', () => {
                panning = false;
                container.style.cursor = 'grab';
                img.style.transition = 'transform 0.1s ease-out';
            });
        </script>
    </div>
    {% endblock %}